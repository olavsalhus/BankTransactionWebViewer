@page
<!DOCTYPE html>
<html lang="en" >
<title>Transaction Viewer</title>

<link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" rel="stylesheet" />
<link href="~/transactions.css" rel="stylesheet" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

<!-- Used for file exports -->
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>

<a style="float: right; font-size: x-large" href="/" ><button class="dt-button">Log out</button></a>

<div class="loading-spinner"></div>

<table id="transactions-table" class="display" hidden style="width: 100%">
    <thead>
        <tr>
            <th>Booking date</th><th>Account</th><th>Description</th><th>Amount</th>
            <th>Currency</th><th>Valuedate</th><th>Debtor</th><th>Creditor</th><th>Creditor account</th>
        </tr>
    </thead>
</table>


<script>
    const jsonColumns = ['bookingDate', 'debtorAccount.bban', 'remittanceInformationUnstructured', 'transactionAmount.amount',
                         'transactionAmount.currency', 'valueDate', 'debtorName', 'creditorName', 'creditorAccount.bban']

    const fetchJson = url => fetch(url).then(response => response.json())
    const reference = '@Request.Query["ref"]'

    fetchJson("/GetAccessToken")
        .then(token =>
            fetchJson(`/ListBankAccounts?reference=${reference}&access_token=${token.access}`).then(ShowBankAccounts)
        )

    const ShowBankAccounts = bankAccounts => {
        bankAccounts.forEach(account => {
            var h2 = document.createElement('h2')
            h2.textContent = `Account: ${account.metadata.iban}, balance: ${account.balances[0].balanceAmount.amount} ${account.balances[0].balanceAmount.currency}`
            h2.style.display = 'inline'

            var clonedTable = document.querySelector("#transactions-table").cloneNode(true)
            clonedTable.id = `${account.id}`
            clonedTable.hidden = false

            var details = document.createElement("details");
            details.open = bankAccounts.length == 1
            var summary = document.createElement("summary");
            summary.style.cursor = 'pointer'
            summary.appendChild(h2);

            details.appendChild(summary);
            details.appendChild(clonedTable);
            document.body.appendChild(details);

            var allTransactions = account.transactions.booked.concat(account.transactions.pending);

            $(clonedTable).DataTable({
                data: allTransactions, paging: false, order: [0, 'desc'],
                columns: jsonColumns.map(jsonColumn => ({ data: jsonColumn, defaultContent: '' })),
                dom: 'Bfrtip',
                buttons: ['copyHtml5', 'excelHtml5', 'csvHtml5', 'pdfHtml5']
            });
        })

        $(".loading-spinner").hide();
    }
</script>
